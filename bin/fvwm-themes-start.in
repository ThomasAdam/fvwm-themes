#!/bin/sh

# This script runs fvwm with fvwm-themes config.  It should be run under X.
# Put a call to this script as the last line of your .Xclients or .xinitrc.

: ${FVWM_USERDIR=@FVWM_DEFAULT_USERDIR@}
rcName=themes-rc
rcFile=$FVWM_USERDIR/$rcName
rcName2=themes-rc-2
rcFile2=$FVWM_USERDIR/$rcName2
themesName=themes
themesDir=$FVWM_USERDIR/$themesName
currentThemeName=current
currentThemeDir=$themesDir/$currentThemeName
startDir=`pwd`
build="no"
start=yes

# Arguments
fvwmArgs=""
whoseArgs="my"
session="main"

while [ "x$1" != "x" ]; do
	case "$1" in
	--)	whoseArgs="fvwm" ;;
	*)	if [ "$whoseArgs" = "fvwm" ]; then
			fvwmArgs="$fvwmArgs '$1'"
		else
			case "$1" in
			--session|-session|-s)
				shift
 				if [ "$1" = "--" ]; then
					whoseArgs="fvwm"
				else
					session="$1"
				fi ;;
			--no-start|-n|-no-start)
				start=no ;;
			esac
		fi ;;
	esac
	shift
done

realCurrentThemeName="current-$session"
realCurrentThemeDir="$themesDir/$realCurrentThemeName"
destRcFile2="$themesName/$realCurrentThemeName/$rcName2"

# create the symbolic links
# POSIX says that we can have symlink to not existing file. However some
# 2.3.x Linux kernel and may be 2.4.x do not support this ???
[ -d $themesDir ] || mkdir -p $themesDir
cd $themesDir
if [ ! -d $realCurrentThemeName ]; then
    mkdir -p $realCurrentThemeName
    build="yes"
fi
rm -f $currentThemeName
ln -s $realCurrentThemeName $currentThemeName
cd $FVWM_USERDIR
if [ ! -f $destRcFile2 ]; then
    touch $destRcFile2
    build="yes"
fi
rm -f $rcName2
ln -s $destRcFile2 $rcName2

# check whether this is a first run
if [ ! -f $rcFile -o "$build" = "yes" -o "`head -1 $rcFile | cut -d' ' -f3`" != "@VERSION@" ]; then
	if [ ! -f $rcFile -o "`head -1 $rcFile | cut -d' ' -f3`" != "@VERSION@" ]; then
		echo '[fvwm-themes]: Welcome to FVWM Themes @VERSION@!'
		xmessage -center -timeout 30 'Welcome to FVWM Themes @VERSION@!' &
	else
		echo "[fvwm-themes]: initial $session FVWM Themes session"
	fi
	@bindir@/fvwm-themes-config --reset
fi

# check that @FVWM_BINDIR@ is in $PATH
if ! which fvwm2 >/dev/null; then
	PATH="@FVWM_BINDIR@:$PATH"
fi

cd $startDir
echo "[fvwm-themes]: Starting FVWM under $session fvwm-themes session"
if [ "$start" = "yes" ]; then
    exec fvwm2 -f "$rcName" $fvwmArgs
fi;